name: "gomicro_load_balanced"
services:
  kong:
    build:
      context: ./kong
      dockerfile: ./Dockerfile-load-balanced
    user: root
    restart: unless-stopped
    ports:
      - "8000:8000"
      - "8443:8443"
      - "8001:8001"
      - "8444:8444"
    depends_on:
      - auth1
      - auth2
      - blog1
      - blog2
    networks:
      - gomicro-network

  # Auth Service Instances for Load Balancing
  auth1:
    build:
      context: ./auth_service
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file:
      - ./auth_service/.env
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy
      redis-auth:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - gomicro-network

  auth2:
    build:
      context: ./auth_service
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file:
      - ./auth_service/.env
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy
      redis-auth:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - gomicro-network

  # Blog Service Instances for Load Balancing
  blog1:
    build:
      context: ./blog_service
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file:
      - ./blog_service/.env
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    depends_on:
      mongo:
        condition: service_healthy
      redis-blog:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - gomicro-network

  blog2:
    build:
      context: ./blog_service
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file:
      - ./blog_service/.env
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    depends_on:
      mongo:
        condition: service_healthy
      redis-blog:
        condition: service_healthy
      nats:
        condition: service_started
    networks:
      - gomicro-network

  # Auth Service Database (PostgreSQL)
  postgres:
    image: postgres:18.1
    restart: unless-stopped
    env_file: ./auth_service/.env
    ports:
      - '5432:5432'
    volumes:
      - ./auth_service/.setup/auth-init-pg-db.sql:/docker-entrypoint-initdb.d/auth-init-pg-db.sql:ro
      - ./auth_service/.setup/auth-init-pg-test-db.sql:/docker-entrypoint-initdb.d/auth-init-pg-test-db.sql:ro
      - postgres-data:/var/lib/postgresql
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -h localhost -p 5432 -U \"$${POSTGRES_USER}\" -d \"$${POSTGRES_DB}\""
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - gomicro-network

    # Database migration for auth service (database) if data seed not used
  # migrate-auth-db:
  #   image: migrate/migrate
  #   env_file: ./auth_service/.env
  #   volumes:
  #     - ./auth_service/migrations:/migrations
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #   entrypoint: ["/bin/sh", "-c"]
  #   command:
  #     - |
  #       migrate -path /migrations -database "postgres://$${DB_USER}:$${DB_USER_PWD}@postgres:5432/$${DB_NAME}?sslmode=disable" up
  #   networks:
  #     - gomicro-network
  #   restart: on-failure

  # Database migration for auth service (test database)
  migrate-auth-test-db:
    image: migrate/migrate
    env_file: ./auth_service/.test.env
    volumes:
      - ./auth_service/migrations:/migrations
    depends_on:
      postgres:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        migrate -path /migrations -database "postgres://$${DB_USER}:$${DB_USER_PWD}@postgres:5432/$${DB_NAME}?sslmode=disable" up
    networks:
      - gomicro-network
    restart: on-failure

  # Blog Service Database (MongoDB)
  mongo:
    image: mongo:8.0.9
    restart: unless-stopped
    env_file: ./blog_service/.env
    ports:
      - '27017:27017'
    command: mongod --bind_ip_all
    volumes:
      - ./blog_service/.setup/blog-init-mongo.js:/docker-entrypoint-initdb.d/blog-init-mongo.js:ro
      - mongo-data:/data/db
    healthcheck:
      test:
      - CMD-SHELL
      - >
        mongosh --quiet
        -u "$$MONGO_INITDB_ROOT_USERNAME"
        -p "$$MONGO_INITDB_ROOT_PASSWORD"
        --authenticationDatabase admin
        --eval "db.runCommand({ ping: 1 }).ok"
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    networks:
      - gomicro-network

  # Redis for Auth Service
  redis-auth:
    image: redis:8.4.0
    restart: unless-stopped
    env_file: ./auth_service/.env
    ports:
      - '6379:6379'
    command: redis-server --bind 0.0.0.0 --save 20 1 --loglevel warning --requirepass changeit
    volumes:
      - redis-auth-data:/data
    healthcheck:
      test:
      - CMD-SHELL
      - redis-cli -a "$$REDIS_PASSWORD" ping
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - gomicro-network

  # Redis for Blog Service
  redis-blog:
    image: redis:8.4.0
    restart: unless-stopped
    env_file: ./blog_service/.env
    ports:
      - '6380:6379'
    command: redis-server --bind 0.0.0.0 --save 20 1 --loglevel warning --requirepass changeit
    volumes:
      - redis-blog-data:/data
    healthcheck:
      test:
      - CMD-SHELL
      - redis-cli -a "$$REDIS_PASSWORD" ping
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - gomicro-network

  # Message broker for inter-service communication
  nats:
    image: nats:2.12.3
    restart: unless-stopped
    env_file: .env
    ports:
      - "${NATS_CLIENT_PORT:-4222}:4222"
      - "${NATS_MANAGEMENT_PORT:-8222}:8222"
    networks:
      - gomicro-network

networks:
  gomicro-network:
    driver: bridge

volumes:
  postgres-data:
  mongo-data:
  redis-auth-data:
  redis-blog-data:
 
